/**
   KA.js
   Version: 1.4.6 Beta
   info: konsili.nl
   Version info: at initial render of component data values are now added for input type's text and checkbox, 1.4.2 : improved method by adding funct setComponentAlterDataValues(), 1.4.3 : changed way cursor pos is determind in KA.bindDataToInputElm (now using startpos instead of lenght), 1.4.4 : added support for bind-data to input type=radio, 1.4.5: added data-ka-bind-data-only and input type=number
   funct setNewData now first checks if data by this name already exists, if so deletes current value
   (c) Konsili 2017, all rights reserved
**/
 


var KA=new Object();KA.init=function(){this.dev=true;if(this.dev)console.log('off we are');this.modules=new Object;this.dataInit();this.compIdTemp='';this.errorsArray=[init=[],data=[],modules=[],components=[]];this.bindDataToInputElm();}
KA.dataInit=function(){this.data=new Object();}
KA.createComponent=function(obj){obj.errorsArray=[];if(!obj.template)obj.errorsArray.push(['Template not defined.']);if(!obj.datatype)obj.errorsArray.push(['Datatype not defined.']);if(obj.datatype=='static'&&!obj.data)obj.errorsArray.push(['Datatype is of type \'static\' but no data defined']);if(obj.render=='default'){obj.render=function(withCompId){withCompId=(typeof withCompId!=='undefined')?withCompId:false;if(!withCompId)var compId=KA.getNewCompId();else compId=withCompId;var html='';html=KA.fillTemplate(obj.template,obj.data,compId,obj.childComponents);if(obj.dataName){if($(html).length>1)html='<div '+'data-ka-comp-id="'+compId+'" data-ka-comp-data="'+obj.dataName+'">'+html+'</div>';else html=$(html).first().attr({'data-ka-comp-id':compId,'data-ka-comp-data':obj.dataName}).prop('outerHTML');}else{if($(html).length>1)html='<div '+'data-ka-comp-id="'+compId+'">'+html+'</div>';else html=$(html).first().attr('data-ka-comp-id',compId).prop('outerHTML');}
return{componentId:compId,html:html};}}
if(obj.render=='repeat'){obj.render=function(withCompId){withCompId=(typeof withCompId!=='undefined')?withCompId:false;if(!withCompId)var compId=KA.getNewCompId();else compId=withCompId;var html='';for(var key in obj.data){html+=KA.fillTemplate(obj.template,obj.data[key],compId);}
html='<div '+'data-ka-comp-id="'+compId+'">'+html+'</div>';return{componentId:compId,html:html};}}
if(obj.render=='custom'){obj.render=function(withCompId){withCompId=(typeof withCompId!=='undefined')?withCompId:false;if(!withCompId)obj.compId=KA.getNewCompId();else obj.compId=withCompId;var html=obj.customRender();if(obj.dataName){if($(html).length>1)html='<div '+'data-ka-comp-id="'+obj.compId+'" data-ka-comp-data="'+obj.dataName+'">'+html+'</div>';else html=$(html).first().attr({'data-ka-comp-id':obj.compId,'data-ka-comp-data':obj.dataName}).prop('outerHTML');}else{if($(html).length>1)html='<div '+'data-ka-comp-id="'+obj.compId+'">'+html+'</div>';else html=$(html).first().attr('data-ka-comp-id',obj.compId).prop('outerHTML');}
return{componentId:obj.compId,html:html};}}
return obj;}
KA.initModule=function(moduleName,moduleActions){var moduleObj=new Object;moduleObj.moduleName=moduleName;moduleObj.moduleRootInDom=document.getElementById(moduleName);moduleObj.moduleRootInDom.innerHTML='';moduleObj.renderComponent=this.renderComponent;moduleObj.moduleActions=moduleActions;this.modules[moduleName]=moduleObj;moduleObj.moduleActions();}
KA.renderComponent=function(component,data){data=(typeof data!=='undefined')?data:false;var compName=component;component=window[component];var dataIsSetInKAData=false;if(data){if(Object.prototype.toString.call(data).slice(8,-1)==='Object'){component.data=data;}else if(Object.prototype.toString.call(data).slice(8,-1)==='String'){if(Object.keys(KA.data).length>0){$.each(KA.data,function(name,dataItem){if(name===data){dataIsSetInKAData=true;component.data=KA.data[name].dataObj;component.dataName=name;}});}}else component.errorsArray.push(['No valid data option given @renderComponent()']);}
var rootElmInDom;if(this.moduleRootInDom)rootElmInDom=this.moduleRootInDom;else rootElmInDom=document.body;if(component.datatype=='static'&&data)component.errorsArray.push(['Datatype is of type \'static\'. DataObj to bound given @renderComponent().']);if(component.datatype!='static'&&component.datatype!='no-data'&&!data)component.errorsArray.push(['No data for component.']);if(component.errorsArray.length>0){if(KA.dev){var errors='';for(var i=0;i<component.errorsArray.length;i++){errors+='error'+(i+1)+': '+component.errorsArray[i];if(i+1!=component.errorsArray.length)errors+=' | ';}
console.log(errors);rootElmInDom.innerHTML+='<p>'+errors+'</p>';}
return;}
var renderedComponentObj=component.render();rootElmInDom.innerHTML+=renderedComponentObj.html;if(dataIsSetInKAData){KA.data[data].bindComponent({component:compName,renderedVersionId:renderedComponentObj.componentId});KA.setComponentAlterDataValues(KA.data[data].dataObj,renderedComponentObj.componentId,'renderComponent');}
if(component.childComponents){for(var childCompItem in component.childComponents){childComp=window[component.childComponents[childCompItem]];if(childComp.events)childComp.events();}}
if(component.events)component.events();}
KA.fillTemplate=function(template,data,compId,childComps){childComps=(typeof childComps!=='undefined')?childComps:false;template=KA.fillTemplateBaseFunction(template,data,compId);if(childComps){for(var childCompItem in childComps){childComp=window[childComps[childCompItem]];var compNameRegex=new RegExp("{{"+childCompItem+"}}","gi");var renderedChildCompObj=childComp.render();template=template.replace(compNameRegex,renderedChildCompObj.html);}}
var ifIsNot=Array();$(template).each(function(){var ifElm=$(this).find('[data-ka-if]');if(ifElm.length>0){for(var i=0;i<ifElm.length;i++){var ifValue=ifElm[i].getAttribute('data-ka-if');var thisifAttr='[data-ka-if="'+ifValue+'"]';if(!data[ifValue])ifIsNot.push(thisifAttr);}}});var filledTemplate='';var templateCopy=template;ifIsNot.forEach(function(ifAttr){templateCopy=$(ifAttr,templateCopy).remove().end();filledTemplate='';templateCopy.each(function(){filledTemplate+=$($(this)[0]).prop('outerHTML');})});if(ifIsNot.length>0)template=filledTemplate;return template;}
KA.fillTemplateBaseFunction=function(template,data,compId,multidimensionalKey){multidimensionalKey=(typeof multidimensionalKey!=='undefined')?multidimensionalKey:false;for(var key in data){if(Object.prototype.toString.call(data[key]).slice(8,-1)==='Object'){if(multidimensionalKey)templateKey=multidimensionalKey;else templateKey=key;for(var itemKey in data[key]){var newTemplateKey='';newTemplateKey=templateKey+'.'+itemKey;if(Object.prototype.toString.call(data[key][itemKey]).slice(8,-1)==='Object'){template=KA.fillTemplateBaseFunction(template,data[key][itemKey],compId,newTemplateKey);}else template=KA.fillTemplateReplaceFunction(template,newTemplateKey,data[key][itemKey],data,compId);}}else if(Object.prototype.toString.call(data[key]).slice(8,-1)==='Array'){if(multidimensionalKey)tkey=multidimensionalKey+'.'+key;else tkey=key;template=KA.fillTemplateReplaceAndRepeatFunction(template,tkey,data[key],compId);}else{if(multidimensionalKey)tkey=multidimensionalKey+'.'+key;else tkey=key;template=KA.fillTemplateReplaceFunction(template,tkey,data[key],data,compId);}}
return template;}
KA.fillTemplateReplaceAndRepeatFunction=function(template,key,value,compId){var elmsToRepeat=$('<div>'+template+'</div>').find('[data-ka-repeat-for]');if(elmsToRepeat.length>0){for(var i=0;i<elmsToRepeat.length;i++){var repeated='';if(elmsToRepeat[i].getAttribute('data-ka-repeat-for')===key){if(value.length>0){for(var i2=0;i2<value.length;i2++){var repeatedSingle=elmsToRepeat[i].outerHTML;for(var keyInArray in value[i2]){repeatedSingle=KA.fillTemplateReplaceFunction(repeatedSingle,keyInArray,value[i2][keyInArray],data,compId);}
repeated+=repeatedSingle;}
var compKeyRegex=new RegExp(elmsToRepeat[i].outerHTML,"gi");template=template.replace(compKeyRegex,repeated);}}}}
return template;}
KA.fillTemplateReplaceFunction=function(template,key,value,data,compId){var compKeyRegex=new RegExp("{{"+key+"}}","gi");if(!value)value='';template=template.replace(compKeyRegex,value);return template;}
KA.setNewData=function(dataName,dataObj){if(this.data.hasOwnProperty(dataName)){delete this.data[dataName];}
dataObj.getPath=function(path,notation){notation=notation||'.';return path.split(notation).reduce(function(prev,cur){return(prev!==undefined)?prev[cur]:undefined;},this);};this.data[dataName]={dataObj:dataObj,boundComponents:[],bindComponent:function(compInfo){this.boundComponents.push(compInfo);},update:function(newDataObj,updateDataOnly){this.dataObj=newDataObj;if(!newDataObj.getPath){newDataObj.getPath=function(path,notation){notation=notation||'.';return path.split(notation).reduce(function(prev,cur){return(prev!==undefined)?prev[cur]:undefined;},this);};}
if(this.boundComponents.length>0&&updateDataOnly===false){$.each(this.boundComponents,function(index,boundComp){KA.updateComponent(boundComp,newDataObj);KA.setComponentAlterDataValues(newDataObj,boundComp.renderedVersionId);});}}}}
KA.setComponentAlterDataValues=function(data,compId,invokedBy){var alterDataElms=$('body').find('[data-ka-alter-data]');if(alterDataElms.length>0){for(var i=0;i<alterDataElms.length;i++){var dataKey=alterDataElms[i].getAttribute('data-ka-alter-data');var thisAlterDataAttr='[data-ka-alter-data="'+dataKey+'"]';if($(thisAlterDataAttr).closest('[data-ka-comp-id]').attr('data-ka-comp-id')===compId){var type=alterDataElms[i].type;var newVal=data.getPath(dataKey);if(type==='text'||type==='number'){if(newVal===false)newVal='';$(thisAlterDataAttr).attr('value',newVal);}
if(type==='checkbox'){if(newVal)$(thisAlterDataAttr).attr('checked','checked');}
if(type==='select-one'){if(invokedBy==='renderComponent'){thisAlterDataAttr+=' [value="'+newVal+'"]';$(thisAlterDataAttr).attr('selected','selected');}else $(thisAlterDataAttr).val(newVal);}
if(type==='radio'){thisAlterDataAttr='input'+thisAlterDataAttr+'[value="'+newVal+'"]';$(thisAlterDataAttr).attr('checked','checked');}}}}
if(invokedBy==='renderComponent'){var alterDataElms=$('body').find('[data-ka-alter-data-only]');if(alterDataElms.length>0){for(var i=0;i<alterDataElms.length;i++){var dataKey=alterDataElms[i].getAttribute('data-ka-alter-data-only');var thisAlterDataAttr='[data-ka-alter-data-only="'+dataKey+'"]';if($(thisAlterDataAttr).closest('[data-ka-comp-id]').attr('data-ka-comp-id')===compId){var type=alterDataElms[i].type;var newVal=data.getPath(dataKey);if(type==='text'||type==='number'){if(newVal===false)newVal='';$(thisAlterDataAttr).attr('value',newVal);}
if(type==='checkbox'){if(newVal)$(thisAlterDataAttr).attr('checked','checked');}
if(type==='select-one'){thisAlterDataAttr+=' [value="'+newVal+'"]';$(thisAlterDataAttr).attr('selected','selected');}
if(type==='radio'){thisAlterDataAttr='input'+thisAlterDataAttr+'[value="'+newVal+'"]';$(thisAlterDataAttr).attr('checked','checked');}}}}}}
KA.updateComponent=function(compInfo,newData){newData=(typeof newData!=='undefined')?newData:false;var errors=[];var compName=compInfo.component;component=window[compInfo.component];if(Object.prototype.toString.call(newData).slice(8,-1)==='Object'){component.data=newData}else{errors.push(['No valid data option given for update']);return errors;}
var compVersionInDomToUpdate=document.querySelectorAll('[data-ka-comp-id="'+compInfo.renderedVersionId+'"]');var renderedComponentObj=component.render(compInfo.renderedVersionId);compVersionInDomToUpdate[0].outerHTML=renderedComponentObj.html;if(component.events)component.events();}
KA.getNewCompId=function(){var ts=+new Date();ts=ts.toString();randi=Math.floor(Math.random()*(500-1+1)+1);return'c'+ts.substring(10)+randi;}
KA.bindDataToInputElm=function(){$('body').on("keyup change",':input',function(e){if($(this).attr('data-ka-alter-data')){var keyExcludeArrayForInputText=[17,18,91,37,38,39,40];var arrowKeys=[37,38,39,40];if((this.type==='text'||this.type==='number')&&e.type==='keyup'&&(($.inArray(e.keyCode,keyExcludeArrayForInputText)<0&&e.keyCode!=16)||(e.keyCode==17&&e.keyCode==86)||(e.keyCode==91&&e.keyCode==86)||(e.keyCode==93&&e.keyCode==86))){var cursorPos=$(this).prop("selectionStart");KA.updateDataPropagateToBoundComp($(this).attr('data-ka-alter-data'),this.value,this.type,$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-id'),$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-data'),false);var key='[data-ka-alter-data="'+$(this).attr('data-ka-alter-data')+'"]';var inputElm=document.querySelector(key);$(inputElm).focus();inputElm.setSelectionRange(cursorPos,cursorPos);}
if(this.type==='checkbox'){KA.updateDataPropagateToBoundComp($(this).attr('data-ka-alter-data'),this.checked,this.type,$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-id'),$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-data'),false);}
if(this.type==='select-one'){KA.updateDataPropagateToBoundComp($(this).attr('data-ka-alter-data'),this.value,this.type,$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-id'),$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-data'),false);var key='[data-ka-alter-data="'+$(this).attr('data-ka-alter-data')+'"]';var inputElm=document.querySelector(key);$(inputElm).focus();}
if(this.type==='radio'){KA.updateDataPropagateToBoundComp($(this).attr('data-ka-alter-data'),this.value,this.type,$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-id'),$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-data'),false);}}
if($(this).attr('data-ka-alter-data-only')){var keyExcludeArrayForInputText=[17,18,91,37,38,39,40];var arrowKeys=[37,38,39,40];if((this.type==='text'||this.type==='number')&&e.type==='keyup'&&(($.inArray(e.keyCode,keyExcludeArrayForInputText)<0&&e.keyCode!=16)||(e.keyCode==17&&e.keyCode==86)||(e.keyCode==91&&e.keyCode==86)||(e.keyCode==93&&e.keyCode==86))){var cursorPos=$(this).prop("selectionStart");KA.updateDataPropagateToBoundComp($(this).attr('data-ka-alter-data-only'),this.value,this.type,$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-id'),$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-data'),true);}
if(this.type==='checkbox'){KA.updateDataPropagateToBoundComp($(this).attr('data-ka-alter-data-only'),this.checked,this.type,$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-id'),$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-data'),true);}
if(this.type==='select-one'){KA.updateDataPropagateToBoundComp($(this).attr('data-ka-alter-data-only'),this.value,this.type,$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-id'),$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-data'),true);}
if(this.type==='radio'){KA.updateDataPropagateToBoundComp($(this).attr('data-ka-alter-data-only'),this.value,this.type,$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-id'),$(this).closest('[data-ka-comp-id]').attr('data-ka-comp-data'),true);}}});}
KA.updateDataPropagateToBoundComp=function(dataKey,newValue,inputType,compId,dataItem,updateDataOnly){newDataObj=this.data[dataItem].dataObj;newDataObj.setPath=function(path,value,notation){function isObject(obj){return(Object.prototype.toString.call(obj)==='[object Object]'&&!!obj);}
notation=notation||'.';path.split(notation).reduce(function(prev,cur,idx,arr){var isLast=(idx===arr.length-1);if(isLast)return(prev[cur]=value);return(isObject(prev[cur]))?prev[cur]:(prev[cur]={});},this);return this;};newDataObj.setPath(dataKey,newValue);delete newDataObj.setPath;this.data[dataItem].update(newDataObj,updateDataOnly);}
KA.init();